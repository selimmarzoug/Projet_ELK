{% extends "base.html" %}

{% block title %}Recherche - ELK Stack Monitor{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
    .search-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.125rem;
    }

    .search-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }

    .search-form {
        display: grid;
        gap: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .form-group input,
    .form-group select {
        padding: 0.75rem 1rem;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        transition: var(--transition);
        background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .search-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: var(--radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background: var(--light);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .results-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .results-count {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .results-count .count {
        color: var(--primary);
        font-size: 1.5rem;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }

    .results-table th {
        background: var(--lighter);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--border);
    }

    .results-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        font-size: 0.875rem;
    }

    .results-table tr:hover {
        background: var(--lighter);
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--secondary);
    }

    .status-failed {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        align-items: center;
    }

    .page-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        background: white;
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
    }

    .page-btn:hover:not(:disabled) {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-large {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    /* Styles DataTables Buttons */
    .dt-buttons {
        margin-bottom: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .dt-button {
        background: var(--primary) !important;
        color: white !important;
        border: none !important;
        padding: 0.75rem 1.5rem !important;
        border-radius: var(--radius) !important;
        font-size: 0.875rem !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: var(--transition) !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .dt-button:hover {
        background: var(--primary-dark) !important;
        transform: translateY(-2px) !important;
        box-shadow: var(--shadow-md) !important;
    }

    .dt-button.buttons-copy {
        background: var(--secondary) !important;
    }

    .dt-button.buttons-copy:hover {
        background: #059669 !important;
    }

    /* DataTables Info */
    .dataTables_info {
        padding: 1rem 0;
        font-weight: 600;
        color: var(--text-secondary);
    }

    /* DataTables Pagination */
    .dataTables_paginate {
        padding: 1rem 0;
    }

    .dataTables_paginate .paginate_button {
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border: 1px solid var(--border);
        background: white;
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
    }

    .dataTables_paginate .paginate_button:hover {
        background: var(--primary);
        color: white !important;
        border-color: var(--primary);
    }

    .dataTables_paginate .paginate_button.current {
        background: var(--primary);
        color: white !important;
        border-color: var(--primary);
    }

    @media (max-width: 768px) {
        .results-table {
            font-size: 0.75rem;
        }

        .results-table th,
        .results-table td {
            padding: 0.5rem;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .dt-buttons {
            flex-direction: column;
        }

        .dt-button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    
    <!-- Page Header -->
    <div class="page-header">
        <h1>üîç Recherche dans les Logs</h1>
        <p>Explorez et filtrez vos donn√©es Elasticsearch</p>
    </div>

    <!-- Search Panel -->
    <div class="search-panel">
        <form id="searchForm" class="search-form">
            <!-- Barre de recherche texte libre -->
            <div class="form-row">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="query">üîç Recherche Texte Libre</label>
                    <input type="text" id="query" name="query" 
                           placeholder="Rechercher dans tous les champs : transaction ID, client, erreur, pays, cat√©gorie..."
                           style="font-size: 1.1rem; padding: 1rem;">
                </div>
            </div>

            <!-- Filtres -->
            <div class="form-row">
                <div class="form-group">
                    <label for="status">üìä Niveau (Statut)</label>
                    <select id="status" name="status">
                        <option value="">Tous les niveaux</option>
                        <option value="success">‚úÖ Success</option>
                        <option value="failed">‚ùå Failed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment_type">üîß Service (Type Paiement)</label>
                    <select id="payment_type" name="payment_type">
                        <option value="">Tous les services</option>
                        <option value="credit_card">Credit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="debit_card">Debit Card</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="apple_pay">Apple Pay</option>
                        <option value="google_pay">Google Pay</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="country">üåç Pays</label>
                    <select id="country" name="country">
                        <option value="">Tous les pays</option>
                        <option value="France">France</option>
                        <option value="Belgium">Belgium</option>
                        <option value="Germany">Germany</option>
                        <option value="Spain">Spain</option>
                        <option value="Italy">Italy</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Switzerland">Switzerland</option>
                    </select>
                </div>
            </div>

            <!-- Date Range -->
            <div class="form-row">
                <div class="form-group">
                    <label for="date_from">üìÖ Date D√©but</label>
                    <input type="datetime-local" id="date_from" name="date_from">
                </div>
                <div class="form-group">
                    <label for="date_to">üìÖ Date Fin</label>
                    <input type="datetime-local" id="date_to" name="date_to">
                </div>
            </div>

            <div class="search-actions">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-redo"></i> R√©initialiser
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Rechercher
                </button>
            </div>
        </form>
    </div>

    <!-- Results Panel -->
    <div class="results-panel" id="resultsPanel" style="display: none;">
        <div class="results-header">
            <div class="results-count">
                <span class="count" id="resultsCount">0</span> r√©sultat(s) trouv√©(s)
            </div>
        </div>

        <div id="resultsContent">
            <!-- Les r√©sultats seront inject√©s ici par JavaScript -->
        </div>

        <div class="pagination" id="pagination">
            <!-- La pagination sera inject√©e ici -->
        </div>
    </div>

</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-large"></div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jQuery (requis pour DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

<script>
let currentPage = 1;
let currentFilters = {};
let dataTable = null;

// Soumettre le formulaire
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    performSearch();
});

// Fonction de recherche
async function performSearch(page = 1) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resultsPanel = document.getElementById('resultsPanel');
    
    // R√©cup√©rer les valeurs du formulaire
    currentFilters = {
        query: document.getElementById('query').value,
        status: document.getElementById('status').value,
        payment_type: document.getElementById('payment_type').value,
        country: document.getElementById('country').value,
        date_from: document.getElementById('date_from').value,
        date_to: document.getElementById('date_to').value,
        page: page,
        size: 50  // 50 logs par page (Prompt 11)
    };

    // Afficher le loading
    loadingOverlay.classList.add('active');

    try {
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentFilters)
        });

        const data = await response.json();

        if (data.success) {
            displayResults(data);
            resultsPanel.style.display = 'block';
        } else {
            alert('Erreur: ' + data.error);
        }
    } catch (error) {
        alert('Erreur lors de la recherche: ' + error.message);
    } finally {
        loadingOverlay.classList.remove('active');
    }
}

// Afficher les r√©sultats avec DataTables
function displayResults(data) {
    const resultsCount = document.getElementById('resultsCount');
    const resultsContent = document.getElementById('resultsContent');
    const pagination = document.getElementById('pagination');

    resultsCount.textContent = data.total;

    if (data.results.length === 0) {
        resultsContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>Aucun r√©sultat trouv√©</h3>
                <p>Essayez de modifier vos crit√®res de recherche</p>
            </div>
        `;
        pagination.innerHTML = '';
        if (dataTable) {
            dataTable.destroy();
            dataTable = null;
        }
        return;
    }

    // D√©truire l'ancienne instance DataTable si elle existe
    if (dataTable) {
        dataTable.destroy();
    }

    // G√©n√©rer le tableau
    let tableHTML = `
        <table id="resultsTable" class="results-table display" style="width:100%">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Transaction</th>
                    <th>Client</th>
                    <th>Montant</th>
                    <th>Paiement</th>
                    <th>Statut</th>
                    <th>Pays</th>
                    <th>Cat√©gorie</th>
                    <th>Erreur</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.results.forEach(log => {
        const timestamp = new Date(log.timestamp).toLocaleString('fr-FR');
        const statusClass = log.status === 'success' ? 'status-success' : 'status-failed';
        const amount = (log.amount && typeof log.amount === 'number') ? log.amount.toFixed(2) : (log.amount || '0.00');
        
        tableHTML += `
            <tr>
                <td>${timestamp}</td>
                <td><code>${log.transaction_id || 'N/A'}</code></td>
                <td>${log.customer_id || 'N/A'}</td>
                <td data-order="${log.amount}">${amount} ‚Ç¨</td>
                <td>${log.payment_type || 'N/A'}</td>
                <td><span class="status-badge ${statusClass}">${log.status || 'unknown'}</span></td>
                <td>${log.country || 'N/A'}</td>
                <td>${log.product_category || 'N/A'}</td>
                <td>${log.error_message || '-'}</td>
            </tr>
        `;
    });

    tableHTML += `
            </tbody>
        </table>
    `;

    resultsContent.innerHTML = tableHTML;

    // Initialiser DataTables avec export CSV
    dataTable = $('#resultsTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv"></i> Export CSV',
                className: 'btn btn-primary',
                filename: 'logs_export_' + new Date().toISOString().slice(0,10),
                exportOptions: {
                    columns: ':visible'
                }
            },
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> Copier',
                className: 'btn btn-secondary'
            }
        ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json'
        },
        pageLength: 25,
        order: [[0, 'desc']],
        responsive: true,
        autoWidth: false
    });

    // Masquer la pagination custom (DataTables g√®re sa propre pagination)
    pagination.style.display = 'none';
}

// Afficher la pagination
function displayPagination(data) {
    const pagination = document.getElementById('pagination');
    let paginationHTML = '';

    // Bouton Pr√©c√©dent
    paginationHTML += `
        <button class="page-btn" onclick="performSearch(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;

    // Num√©ros de page
    const maxPages = Math.min(data.total_pages, 5);
    let startPage = Math.max(1, data.page - 2);
    let endPage = Math.min(data.total_pages, startPage + maxPages - 1);

    if (startPage > 1) {
        paginationHTML += `<button class="page-btn" onclick="performSearch(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span>...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === data.page ? 'active' : '';
        paginationHTML += `
            <button class="page-btn ${activeClass}" onclick="performSearch(${i})">${i}</button>
        `;
    }

    if (endPage < data.total_pages) {
        if (endPage < data.total_pages - 1) {
            paginationHTML += `<span>...</span>`;
        }
        paginationHTML += `<button class="page-btn" onclick="performSearch(${data.total_pages})">${data.total_pages}</button>`;
    }

    // Bouton Suivant
    paginationHTML += `
        <button class="page-btn" onclick="performSearch(${data.page + 1})" ${data.page >= data.total_pages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;

    pagination.innerHTML = paginationHTML;
}

// R√©initialiser le formulaire
function resetForm() {
    document.getElementById('searchForm').reset();
    document.getElementById('resultsPanel').style.display = 'none';
}

// Recherche initiale (tous les logs)
window.addEventListener('load', function() {
    performSearch();
});
</script>
{% endblock %}
