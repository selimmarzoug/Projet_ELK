name: CI/CD Pipeline - ProjetELK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.8'
  DOCKER_IMAGE: selimmarzoug/projetelk-webapp

jobs:
  # ===================================
  # JOB 1: Linting et Quality Check
  # ===================================
  lint:
    name: ğŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black
    
    - name: ğŸ¨ Check code formatting with Black
      run: |
        black --check webapp/ tests/ || echo "âš ï¸ Code needs formatting"
    
    - name: ğŸ” Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 webapp/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 webapp/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ“Š Lint with pylint
      run: |
        pylint webapp/ --exit-zero || echo "âš ï¸ Pylint warnings detected"
    
    - name: âœ… Linting completed
      run: echo "âœ… Code quality checks passed"

  # ===================================
  # JOB 2: Tests Unitaires
  # ===================================
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask pytest-mock
    
    - name: ğŸ§ª Run unit tests
      run: |
        python -m pytest tests/ -m unit -v --tb=short --cov=webapp --cov-report=xml --cov-report=term
    
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-projetelk
        fail_ci_if_error: false
    
    - name: âœ… Tests completed
      run: echo "âœ… Unit tests passed"

  # ===================================
  # JOB 3: Tests d'IntÃ©gration
  # ===================================
  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.3
        env:
          discovery.type: single-node
          xpack.security.enabled: false
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
      
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
      
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask pytest-mock
    
    - name: ğŸ”— Run integration tests
      env:
        ELASTICSEARCH_HOST: localhost:9200
        MONGODB_HOST: localhost:27017
        MONGODB_USERNAME: admin
        MONGODB_PASSWORD: testpass
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: |
        python -m pytest tests/ -m integration -v --tb=short
    
    - name: âœ… Integration tests completed
      run: echo "âœ… Integration tests passed"

  # ===================================
  # JOB 4: Build Docker Image
  # ===================================
  build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # Docker Hub login dÃ©sactivÃ© - pas besoin pour build local
    # - name: ğŸ” Login to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}
    #   if: github.event_name != 'pull_request'
    
    - name: ğŸ“ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: ğŸ—ï¸ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}
    
    - name: âœ… Build completed
      run: echo "âœ… Docker image built successfully"

  # ===================================
  # JOB 5: Push Docker Image (Main only)
  # ===================================
  push:
    name: ğŸš€ Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: false  # DÃ©sactivÃ© - pas de Docker Hub configurÃ©
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ“ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE }}
        tags: |
          type=raw,value=latest
          type=sha
    
    - name: ğŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: âœ… Push completed
      run: echo "âœ… Docker image pushed to registry"

  # ===================================
  # JOB 6: Verify Docker Image
  # ===================================
  verify:
    name: âœ… Verify Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ—ï¸ Build image locally
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        load: true
        tags: projetelk/webapp:latest
        cache-from: type=gha
    
    - name: âœ… Verify image built
      run: |
        echo "âœ… Docker image built successfully!"
        docker images | grep projetelk
        echo "Image ready for deployment: projetelk/webapp:latest"
    
    - name: ğŸ‰ Pipeline completed
      run: |
        echo "ğŸ‰ CI/CD Pipeline completed successfully!"
        echo "âœ… All tests passed"
        echo "âœ… Docker image ready"
        echo "Ready to deploy with: docker-compose up -d"
